<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weather Info</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; margin: 0; }
    .container { max-width: 400px; margin: 80px auto; background: #fff; padding: 32px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #2c3e50; margin-bottom: 24px; }
    input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; transition: border-color 0.3s; }
    input:focus { outline: none; border-color: #3498db; }
    button { width: 100%; padding: 12px; margin: 16px 0; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background 0.3s; }
    button:hover { background: #2980b9; }
    .result { margin-top: 20px; background: #f8f9fa; padding: 16px; border-radius: 8px; box-shadow: inset 0 0 6px rgba(0,0,0,0.05); }
    .error { color: #e74c3c; text-align: center; margin-top: 12px; }
    .weather-item { margin: 8px 0; }
    .loading { text-align: center; color: #666; }
    .location-btn { background: #27ae60; margin-bottom: 16px; }
    .location-btn:hover { background: #219a52; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Weather Info</h2>
    <button type="button" class="location-btn" id="getLocation">Use My Location</button>
    <form id="weatherForm">
      <input type="number" step="any" id="latitude" placeholder="Latitude (e.g. 48.8566)" required>
      <input type="number" step="any" id="longitude" placeholder="Longitude (e.g. 2.3522)" required>
      <button type="submit">Get Weather</button>
    </form>
    <div class="result" id="result"></div>
    <div class="error" id="errorMsg"></div>
  </div>
  <script>
    const form = document.getElementById('weatherForm');
    const resultDiv = document.getElementById('result');
    const errorDiv = document.getElementById('errorMsg');
    const locationBtn = document.getElementById('getLocation');
    const latInput = document.getElementById('latitude');
    const lonInput = document.getElementById('longitude');

    async function getWeather(latitude, longitude) {
      try {
        resultDiv.innerHTML = '<div class="loading">Fetching weather data...</div>';
        const res = await fetch(`/api/v1/tasks/weather?latitude=${latitude}&longitude=${longitude}`);
        if (!res.ok) throw new Error('Failed to fetch weather data. Please try again.');
        const data = await res.json();
        if (data.current_weather) {
          const weatherDescriptions = {
            0: 'Clear sky',
            1: 'Mainly clear',
            2: 'Partly cloudy',
            3: 'Overcast',
            45: 'Foggy',
            48: 'Depositing rime fog',
            51: 'Light drizzle',
            53: 'Moderate drizzle',
            55: 'Dense drizzle',
            61: 'Slight rain',
            63: 'Moderate rain',
            65: 'Heavy rain',
            71: 'Slight snow fall',
            73: 'Moderate snow fall',
            75: 'Heavy snow fall',
            77: 'Snow grains',
            80: 'Slight rain showers',
            81: 'Moderate rain showers',
            82: 'Violent rain showers',
            85: 'Slight snow showers',
            86: 'Heavy snow showers',
            95: 'Thunderstorm',
          };
          const weatherDesc = weatherDescriptions[data.current_weather.weathercode] || 'Unknown weather condition';
          resultDiv.innerHTML = `
            <div class="weather-item"><strong>Weather:</strong> ${weatherDesc}</div>
            <div class="weather-item"><strong>Temperature:</strong> ${data.current_weather.temperature}Â°C</div>
            <div class="weather-item"><strong>Wind Speed:</strong> ${data.current_weather.windspeed} km/h</div>
          `;
        } else {
          resultDiv.innerHTML = 'No weather data found for this location.';
        }
      } catch (err) {
        errorDiv.textContent = err.message;
      }
    }

    locationBtn.addEventListener('click', () => {
      if (!navigator.geolocation) {
        errorDiv.textContent = 'Geolocation is not supported by your browser';
        return;
      }

      locationBtn.textContent = 'Getting location...';
      navigator.geolocation.getCurrentPosition(
        (position) => {
          latInput.value = position.coords.latitude;
          lonInput.value = position.coords.longitude;
          locationBtn.textContent = 'Use My Location';
          getWeather(position.coords.latitude, position.coords.longitude);
        },
        (error) => {
          let errorMessage = 'Failed to get location. ';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMessage += 'Please allow location access or enter coordinates manually.';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage += 'Location information unavailable.';
              break;
            case error.TIMEOUT:
              errorMessage += 'Location request timed out.';
              break;
            default:
              errorMessage += 'An unknown error occurred.';
          }
          errorDiv.textContent = errorMessage;
          locationBtn.textContent = 'Use My Location';
        }
      );
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorDiv.textContent = '';
      const latitude = latInput.value;
      const longitude = lonInput.value;
      await getWeather(latitude, longitude);
    });
  </script>
</body>
</html>